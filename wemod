#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_PATH="$ROOT_DIR/wemod-launcher"

status() {
  echo "[wemod-wrapper] $*" >&2
}

run_launcher() {
  if [[ -x "$BIN_PATH" ]]; then
    status "starting binary: $BIN_PATH"
    exec "$BIN_PATH" "$@"
  fi

  if command -v go >/dev/null 2>&1; then
    status "binary not found, starting via go run"
    exec go run "$ROOT_DIR/cmd/wemod-launcher" -- "$@"
  fi

  echo "wemod-launcher binary not found and Go toolchain is unavailable." >&2
  echo "Build with: go build -o wemod-launcher ./cmd/wemod-launcher" >&2
  exit 1
}

first_arg="${1:-}"
case "$first_arg" in
  launch|setup|doctor|prefix|config|help|--help|-h|--version|-version)
    status "mode: explicit command ($first_arg)"
    run_launcher "$@"
    ;;
  *)
    status "mode: Steam passthrough (launch -- %command%)"
    run_launcher launch -- "$@"
    ;;
esac
